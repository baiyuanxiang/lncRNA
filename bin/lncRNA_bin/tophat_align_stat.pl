#!/user/bin/perl -w
use strict;
die "perl $0 <align_summary.txt> <sample name> <output table>" unless @ARGV ==3;
my ($summary,$name,$out) = @ARGV;
my $read1 = `grep 'Input' $summary|head -1`;
my $read2 = `grep 'Input' $summary|tail -1`;
$read1 =~ /(\d+)/;
my $read1_num = $1;
$read2 =~ /(\d+)/;
my $read2_num = $1;
my $total_reads = $read1_num + $read2_num;
if ($read1_num != $read2_num)
{
	print "error: read1 number not equal to reads2,please check!\n";
}
my $mapped_1 = `grep 'Mapped' $summary|head -1`;
my $mapped_2 = `grep 'Mapped' $summary|tail -1`;
$mapped_1 =~ /(\d+) \((\d+.\d)% of input\)/;
my $read1_mapped = $1;
my $read1_mapped_percent=$2;
$mapped_2 =~ /(\d+) \((\d+.\d)% of input\)/;
my $read2_mapped = $1;
my $read2_mapped_percent=$2;
my $total_mapped_reads = $read1_mapped + $read2_mapped;
my $maprate = `grep 'overall read mapping rate' $summary`;
$maprate =~ /(\d+.\d)%/;
my $total_mapped_rate = $1;
my $multi_1 = `grep 'multiple alignments' $summary |head -1`;
my $multi_2 = `grep 'multiple alignments' $summary |head -2 |tail -1`;
my $multi_3 = `grep 'multiple alignments' $summary |tail -1`;
$multi_1 =~ /(\d+) \((\s*\d+.\d)%\)/;
my $read1_multi_align = $1;
my $read1_multi_align_percent = $2;
my $read1_uniq = $read1_mapped - $read1_multi_align;
my $read1_uniq_rate = 100 - $read1_multi_align_percent;
$multi_2 =~ /(\d+) \((\s*\d+.\d)%\)/;
my $read2_multi_align = $1;
my $read2_multi_align_percent = $2;
my $read2_uniq = $read2_mapped - $read2_multi_align;
my $read2_uniq_rate = 100 - $read2_multi_align_percent;
my $total_uniq = $read1_uniq + $read2_uniq;
my $total_uniq_rate = $total_uniq*100/$total_mapped_reads;
my $total_multi_reads = $read1_multi_align + $read2_multi_align;
my $total_multi_reads_rate = $total_multi_reads*100/$total_mapped_reads;
$multi_3 =~ /(\d+) \((\s*\d+.\d)%\)/;
my $pair_multi_align = $1;
my $pair_multi_align_percent = $2;
my $pair = `grep 'Aligned pairs' $summary`;
$pair =~ /(\d+)/;
my $align_pair = $1;
my $pair_uniq = $align_pair - $pair_multi_align;
my $pair_uniq_rate = 100 - $pair_multi_align_percent;
my $pair_rate = `grep 'concordant pair alignment rate' $summary`;
$pair_rate =~ /(\d+.\d)%/;
my $total_concordant_pair_rate = $1;
my $discordant = `grep 'discordant alignments' $summary`;
$discordant =~ /(\d+) \((\s*\d+.\d)%\)/;
my $discordant_pairs = $1;
my $discordant_pairs_rate = $2;
my $concordant_pair = $align_pair - $discordant_pairs;
my $concordant_pair_rate = 100 - $discordant_pairs_rate;
open OUT,">$out" or die;
print OUT "Iterm\t$name\n";
print OUT "Total reads\t$total_reads\n";
print OUT "Total mapped reads\t$total_mapped_reads\n";
print OUT "Total mapped rate\t$total_mapped_rate%\n";
print OUT "Total uniq mapped reads\t$total_uniq\n";
printf OUT "Total uniq mapped rate\t%.1f","$total_uniq_rate";
print OUT  "%\n" ;
print OUT "Total multiple mapped reads\t$total_multi_reads\n";
printf OUT "Total multiple mapped rate\t%.1f","$total_multi_reads_rate";
print OUT "%\n";
print OUT "Read1 number\t$read1_num\n";
print OUT "Read1 mapped\t$read1_mapped\n";
print OUT "Read1 mapped rate\t$read1_mapped_percent%\n";
print OUT "Read1 uniq mapped\t$read1_uniq\n";
print OUT "Read1 uniq mapped rate\t$read1_uniq_rate%\n";
print OUT "Read1 multiple mapped\t$read1_multi_align\n";
print OUT "Read1 multiple mapped rate\t$read1_multi_align_percent%\n";
print OUT "Read2 number\t$read2_num\n";
print OUT "Read2 mapped\t$read2_mapped\n";
print OUT "Read2 mapped rate\t$read2_mapped_percent%\n";
print OUT "Read2 uniq mapped\t$read2_uniq\n";
print OUT "Read2 uniq mapped rate\t$read2_uniq_rate%\n";
print OUT "Read2 multiple mapped\t$read2_multi_align\n";
print OUT "Read2 multiple mapped rate\t$read2_multi_align_percent%\n";
print OUT "Aligned pairs\t$align_pair\n";
print OUT "Pairs uniq mapped\t$pair_uniq\n";
print OUT "Pairs uniq mapped rate\t$pair_uniq_rate%\n";
print OUT "Pairs multiple mapped\t$pair_multi_align\n";
print OUT "Pairs multiple mapped rate\t$pair_multi_align_percent%\n";
print OUT "concordant pair\t$concordant_pair\n";
print OUT "concordant pairs rate\t$concordant_pair_rate%\n";
print OUT "discordant pairs\t$discordant_pairs\n";
print OUT "discordant pairs rate\t$discordant_pairs_rate%\n";
print OUT "concordant pair rate(total)\t$total_concordant_pair_rate%";

close OUT;
